function Position(t,e){return{x:t,y:e}}function Size(t,e){return{width:t,height:e}}const DEFAULT_FONT_SIZE=11,MIN_FONT_SIZE=7,MAX_FONT_WIDTH=83,NAME_POSITION=Position(119,696),BIRTHDAY_POSITION=Position(119,674),PLACE_OF_BIRTH_POSITION=Position(297,674),ADDRESS_POSITION=Position(133,652),CITY_POSITION=Position(105,177),REASONS=["travail","achats","sante","famille","handicap","sport_animaux","convocation","missions","enfants"],REASON_POSITIONS=[Position(78,578),Position(78,533),Position(78,477),Position(78,435),Position(78,396),Position(78,358),Position(78,295),Position(78,255),Position(78,211)],REASON_SIZE=18,DATE_POSITION=Position(91,153),DATE_SIZE=11,TIME_POSITION=Position(264,153),TIME_SIZE=11,QRCODE_POSITIONS=[Position(156,100),Position(50,350)],QRCODE_SIZES=[Size(92,92),Size(300,300)],PDF_BASE_URL="../base.pdf",PDF_TITLE="COVID-19 - Déclaration de déplacement",PDF_SUBJECT="Attestation de déplacement dérogatoire",PDF_PRODUCER="COVID Certificate generator",PDF_AUTHOR="Félix Voituret",PDF_CREATOR="",PDF_KEYWORDS=["covid19","covid-19","attestation","déclaration","déplacement"],QRCODE_OPTIONS={errorCorrectionLevel:"M",type:"image/png",quality:.92,margin:1};async function loadPDF(){const t=await fetch(PDF_BASE_URL).then(t=>t.arrayBuffer()),e=await PDFDocument.load(t);return e.setTitle(PDF_TITLE),e.setSubject(PDF_SUBJECT),e.setKeywords(PDF_KEYWORDS),e.setProducer(PDF_PRODUCER),e.setCreator(PDF_CREATOR),e.setAuthor(PDF_AUTHOR),e.addPage(),e}async function generateCertificateQRCode(t){let e=[`Cree le: ${t.date} a ${t.time}`,`Nom: ${t.lastname}`,`Prenom: ${t.firstname}`,`Naissance: ${t.birthday} a ${t.placeofbirth}`,`Adresse: ${t.address} ${t.zipcode} ${t.city}`,`Sortie: ${t.date} a ${t.time}`,`Motifs: ${REASONS[t.reason]}`];return e=e.join(";\n "),QRCode.toDataURL(e,QRCODE_OPTIONS)}function getCitySize(t,e){let i=DEFAULT_FONT_SIZE,a=e.widthOfTextAtSize(t,DEFAULT_FONT_SIZE);for(;a>MAX_FONT_WIDTH&&i>MIN_FONT_SIZE;)a=e.widthOfTextAtSize(t,--i);let o=a>MAX_FONT_WIDTH?null:i;return o||(o=7),o}async function generateCertificatePDF(t){const e=await loadPDF(),i=await generateCertificateQRCode(t),a=await e.embedFont(StandardFonts.Helvetica),o=await e.embedPng(i),n=e.getPages(),O=(t,e,i=11)=>{n[0].drawText(t,{x:e.x,y:e.y,size:i,font:a})},S=getCitySize(t.city,a);O(`${t.firstname} ${t.lastname}`,NAME_POSITION),O(t.birthday,BIRTHDAY_POSITION),O(t.placeofbirth,PLACE_OF_BIRTH_POSITION),O(`${t.address} ${t.zipcode} ${t.city}`,ADDRESS_POSITION),O(t.city,CITY_POSITION,S),O(`${t.date}`,DATE_POSITION,DATE_SIZE),O(`${t.time}`,TIME_POSITION,TIME_SIZE),O("x",REASON_POSITIONS[t.reason],REASON_SIZE),n[0].drawImage(o,{x:n[0].getWidth()-QRCODE_POSITIONS[0].x,y:QRCODE_POSITIONS[0].y,width:QRCODE_SIZES[0].width,height:QRCODE_SIZES[0].height}),n[1].drawImage(o,{x:QRCODE_POSITIONS[1].x,y:n[1].getHeight()-QRCODE_POSITIONS[1].y,width:QRCODE_SIZES[1].width,height:QRCODE_SIZES[1].height});const I=await e.save();return new Blob([I],{type:"application/pdf"})}async function generateAndDownload(t){const e=atob(t),i=JSON.parse(e),a=new Date;i.date=a.toLocaleDateString("fr-FR"),i.time=a.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}).replace(":","h");const o=await generateCertificatePDF(i,reasons,pdfBase),n=URL.createObjectURL(o),O=document.createElement("a");O.href=n,O.download=`attestation-${creationDate}_${creationHour}.pdf`,document.body.appendChild(O),O.click()}